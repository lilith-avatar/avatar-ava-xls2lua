# Avatar Ava-xls2lua
莉莉丝游戏达芬奇计划内容组Excel转Lua工具（适用于Ava框架），简称x2l

[![](https://img.shields.io/badge/-DaVinci-MediumPurple)](http://api.projectdavinci.com/)
[![](https://img.shields.io/badge/project-Ava-ff69b4)](https://github.com/lilith-avatar/avatar-ava/projects/1)
[![](https://img.shields.io/badge/-wiki-DeepSkyBlue)](https://github.com/lilith-avatar/avatar-ava/wiki)
[![](https://img.shields.io/github/v/release/lilith-avatar/avatar-ava-xls2lua)](https://github.com/lilith-avatar/avatar-ava-xls2lua/releases)

[![logo](https://user-images.githubusercontent.com/4829591/96980600-01679800-1552-11eb-9bc3-b6e9a6f5bcde.png)](https://github.com/lilith-avatar/avatar-ava-xls2lua)

## 介绍

ava-xls2lua是一款编辑器的外部工具，可将Excel表格批量转换成Lua脚本，简称x2l

* Clone from [luzexi/xls2lua](https://github.com/luzexi/xls2lua)
* 程序语言：[Python 3](https://www.python.org/)
* 引用模块：[xlrd](https://pypi.org/project/xlrd/)，[xlwt](https://pypi.org/project/xlutils/)，[xlutils](https://pypi.org/project/xlutils/)，[wxPython](https://wxpython.org/)
* 打包模块：[PyInstaller](https://pypi.org/project/pyinstaller/)
* 证书：[MIT License](https://github.com/lilith-avatar/avatar-ava-xls2lua/blob/master/LICENSE)

## 开发文档

### 源代码安装环境

1. 下载并安装 [Python 3.8.6](https://www.python.org/downloads/release/python-386/)
2. 下载并安装 [Build Tools for Visual Studio](https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2019)
3. 点击运行`init.bat`，安装Python库

### 运行Python脚本

打开`cmd`或`PowerShell`，切换到项目根目录
1. 输入`> python .\ava_xls2lua.py`，运行x2l内核脚本
2. 输入`> python .\gui.py`，运行GUI和x2l内核

### 用PyInstaller发布`.exe`程序

点击运行`build.bat`，自动在项目根目录下生成`ava-x2l.exe`

## 主要功能

* 将Excel文件批量生成对应的Lua脚本，支持`.xls` `.xlsx` `.xlsm`
* 可以根据不同的项目结构配置目录和文件名前后缀
* 支持多语言导出，自动在翻译表中生成翻译ID和条目

## <a name='vartype'>在Excel中支持的数据类型</a>

* 基础类型：`Int`，`Float`，`String`，`Bool`
* 数组类型：`Int[]`，`Float[]`，`String[]`，`Bool[]`
* 编辑器类型：`Vector2`，`Vector3`，`Euler`，`Color`
* Lua代码：`Lua`
* 批注类型：`Comment`（不会被转换成Lua代码）
* 翻译类型：`Translate`（在翻译表中生成对应的翻译ID，并导出Lua代码）

## <a name='config'>配置介绍</a>

双击`ava-x2l.exe`，打开ava-xls2lua GUI，勾选GUI右下角的`Config`可以配置相关设置

![GUI](https://user-images.githubusercontent.com/64057282/96594287-08599500-131d-11eb-9c6b-f64ba1dc42ef.png)

* Input Path：Excel文件所在目录
* Output Path：生成的Lua脚本所在目录
* Output Lua Template：Lua脚本文件名前缀，其中`{sheet_name}`是通配符，请保留
* KV Format Excel Files：配置方式为KV键值对的表，只含有`Key`和`Value`，通常用于全局变量
* Translate Excel Files：翻译表的名称，必须在Excel文件目录下

## 如何使用

* 配置完成之后，点击GUI左下角的`Convert`按钮，开始进行Lua脚本的生成
* 成功转换的lua脚本，会显示`[sucess]`，全部脚本生成之后，会显示`[info] done`
* 如果中途遇到报错，log会显示报错`[error]`或`[failed]`，根据相关提示进行检查
* [策划表格转换示例](#eg-d)

![GUI](https://user-images.githubusercontent.com/4829591/96977162-4a6a1d00-154f-11eb-9851-52fbcc5d0a13.png)

## Excel格式

### Sheet的格式
Excel文件中，有`output_`前缀的Sheet表格会生成对应的lua文件

支持Excel中多张Sheet的导出

![GUI](https://user-images.githubusercontent.com/4829591/96976073-f3177d00-154d-11eb-8cca-576656cd336a.png)

### 表头的格式

表头有四行，分别是：变量中文描述，英文变量名，数据类型，主键
* 变量中文描述：表述列的信息，如何配置，不会导出到Lua中
* 英文变量名：导出Lua脚本中的变量名称
* 数据类型：x2l会根据不动的变量类型生成对应的Lua行，[支持类型](#vartype)，支持大小写模糊
* 主键：最多有三个，`Key1`，`Key2`，`Key3`，x2l会根据主键来生成Lua Table的结构，主键必须是`Int`或`String`，支持大小写模糊
* 数据：从第`5`行开始

![GUI](https://user-images.githubusercontent.com/4829591/96977951-628e6c00-1550-11eb-86bf-22fc4cb7ed7c.png)

### KV样式表格与配置

* 在[配置](#config)中配置`KV Format Excel Files:`，支持多张KV样式的Excel
* 表中有`3`列，`Key`，`Value`，`Des`
  * `Key`：类型为`Int`或`String`，设为主键`Key1`
  * `Value`：类型为`Lua`，直接在数据中填写Lua
  * `Des`：类型为`Comment`，不进行Lua生成
* KV样式表中不支持`Translate`类型
* [KV表格示例](#eg-kv)

### 翻译表的格式与配置

* 在[配置](#config)中配置`Translate Excel File:`，定义多语言Excel翻译表
* 多语言表格必须是`xls`文件，否则写入会报错
* 多语言配置必须有
  * `ID`：生成的翻译ID，类型为`String`，设为主键`Key1`
  * `CHS`：简体中文字节码，类型为`String`
  * 其他对应的字节码
* 在需要翻译的策划表对应列中，配置数据类型为`Translate`，数据为简体中文文本
* 转换中，x2l会根据策划表的`表名称`、`列名`、`主键`生成唯一的翻译`ID`，并将`ID`放置在翻译表中，同时在Lua脚本中用`ID`替代中文文本
* 之后请本地化部门对翻译表进行翻译，配置对应的多语言翻译条目
* 注意
  * 翻译表在转换中最后一个生成Lua脚本
  * 在x2l转换过程中，翻译表需要关闭，否则会报错`PermissionError`
* [翻译表示例](#eg-trans)

## 示例

### <a name='eg-d'>策划表批量转换成Lua脚本</a>

Excel目录，包含策划表，KV表，多语言表

![xls folder](https://user-images.githubusercontent.com/4829591/96994436-4d6d0980-155f-11eb-8369-951a4b8ae321.png)


策划表`ExampleTable1.xls`的`output_Example1`表数据

![xls sheet](https://user-images.githubusercontent.com/4829591/96995474-dd5f8300-1560-11eb-85a6-2efca1a41197.png)


使用x2l转换

![use x2l convert](https://user-images.githubusercontent.com/4829591/96993751-50b3c580-155e-11eb-9aa9-a15725fffc82.gif)

生成Lua脚本目录

![lua folder](https://user-images.githubusercontent.com/4829591/96996183-03395780-1562-11eb-9e0c-cfde76d966a3.png)

`output_Example1`表生成对应Lua脚本`['World']['Global']['Xls']['Example1XlsModule'].ModuleScript.lua`

```lua
--- This file is generated by ava-x2l.exe,
--- Don't change it manaully.
--- @copyright Lilith Games, Project Da Vinci(Avatar Team)
--- @see https://www.projectdavinci.com/
--- @see https://github.com/endaye/avatar-ava-xls2lua
--- source file: ./xls/ExampleTable1.xls

local Example1Xls = {
    [1] = {
        house = {
            GroupNum = 1,
            Name = 'house',
            Weight = 2.33,
            IsInit = true,
            Score = 100,
            Position = Vector3(1, 2, 3),
            Salary = {1.23, 2, 3.23}
        },
        MMM = {
            GroupNum = 1,
            Name = 'MMM',
            Weight = 336.2,
            IsInit = true,
            Score = 0,
            Position = Vector3(1, 2, 3),
            Salary = {1, 2.3445, 3}
        },
        ddd = {
            GroupNum = 1,
            Name = 'ddd',
            Weight = 222.33665,
            IsInit = false,
            Score = 130,
            Position = Vector3(3, 2, 5),
            Salary = {3, 2, 2.5}
        }
    },
    [2] = {
        farm = {
            GroupNum = 2,
            Name = 'farm',
            Weight = 220.0,
            IsInit = false,
            Score = 200,
            Position = Vector3(2, 3, 4),
            Salary = {200.3, 3, 234.23}
        },
        MMM = {
            GroupNum = 2,
            Name = 'MMM',
            Weight = 22.1,
            IsInit = false,
            Score = 234,
            Position = Vector3.Zero,
            Salary = {3, 6.3, 6, 7}
        }
    }
}

return Example1Xls

```

### <a name='eg-kv'>KV样式的表格导出</a>

在`Config`中配置`[GlobalSetting.xlsx]`表为KV格式的表格，并生成Lua脚本

![KV](https://user-images.githubusercontent.com/4829591/96987406-8acc9980-1555-11eb-97a5-83410069bbf8.png)

生成后的`['World']['Global']['Xls']['GlobalSettingXlsModule'].ModuleScript.lua`

```lua
--- This file is generated by ava-x2l.exe,
--- Don't change it manaully.
--- @copyright Lilith Games, Project Da Vinci(Avatar Team)
--- @see https://www.projectdavinci.com/
--- @see https://github.com/endaye/avatar-ava-xls2lua
--- source file: ./xls/GlobalSetting.xlsx

local GlobalSettingXls = {
    SeaLevelMax = true,
    SeaLevelMiddle = Vector3(0,-14.5,0),
    BridgeMin = Vector3(0,-15,0),
    PlaneSideLength = 30.0,
    FlashFrequency = 0.1,
    NoticeMoveTime = 0.5,
    NoticeStayTime = 3.0
}

return GlobalSettingXls
```

### <a name='eg-trans'>翻译表导出示例</a>

在`Config`中配置`LanguagePack.xls`表为翻译表

在策划表中配置`Translate`列和对应的中文文本信息，并生成Lua脚本

![Trans](https://user-images.githubusercontent.com/4829591/96991592-4512cf80-155b-11eb-89ca-70fd8dae9f93.png)

生成后的Lua策划表

```lua
--- This file is generated by ava-x2l.exe,
--- Don't change it manaully.
--- @copyright Lilith Games, Project Da Vinci(Avatar Team)
--- @see https://www.projectdavinci.com/
--- @see https://github.com/endaye/avatar-ava-xls2lua
--- source file: ./xls/ExampleTable1.xls

local Example1Xls = {
    [1] = {
        house = {
            ID = 1,
            Group = 'house',
            Weight = 2.33,
            Dialog1 = 'Example1_Dialog1_1_house',   -- 这里变成了翻译表中的ID
            Dialog2 = 'Example1_Dialog2_1_house'    -- 这里变成了翻译表中的ID
        },
        MMM = {
            ID = 1,
            Group = 'MMM',
            Weight = 336.2,
            Dialog1 = 'Example1_Dialog1_1_MMM',     -- 这里变成了翻译表中的ID
            Dialog2 = 'Example1_Dialog2_1_MMM'      -- 这里变成了翻译表中的ID
        },
        ddd = {
            ID = 1,
            Group = 'ddd',
            Weight = 222.33665,
            Dialog1 = 'Example1_Dialog1_1_ddd',     -- 这里变成了翻译表中的ID
            Dialog2 = 'Example1_Dialog2_1_ddd'      -- 这里变成了翻译表中的ID
        }
    },
    [2] = {
        farm = {
            ID = 2,
            Group = 'farm',
            Weight = 220.0,
            Dialog1 = 'Example1_Dialog1_2_farm',    -- 这里变成了翻译表中的ID
            Dialog2 = 'Example1_Dialog2_2_farm'     -- 这里变成了翻译表中的ID
        },
        MMM = {
            ID = 2,
            Group = 'MMM',
            Weight = 22.1,
            Dialog1 = 'Example1_Dialog1_2_MMM',     -- 这里变成了翻译表中的ID
            Dialog2 = 'Example1_Dialog2_2_MMM'      -- 这里变成了翻译表中的ID
        }
    }
}

return Example1Xls
```

更新后的翻译表`LanguagePack.xls`，会多了对应的翻译`ID`

![image](https://user-images.githubusercontent.com/4829591/96992897-1eee2f00-155d-11eb-9d89-5b3e8f94716d.png)
